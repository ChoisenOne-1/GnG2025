<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Medical Help</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 24px; background:#fafafa; }
  .card { max-width: 680px; margin: 0 auto; padding: 20px 24px; border: 1px solid #ddd; border-radius: 16px; background:#fff; box-shadow: 0 1px 8px rgba(0,0,0,.04); }
  h1 { margin: 0 0 8px; font-size: 1.4rem; }
  #status { margin-top: 12px; color: #555; min-height: 1.4em; }
  .btn { display:inline-block; margin-top:16px; padding:16px 20px; font-weight:600; border-radius: 12px; border:none; cursor:pointer; width:100%;
         background:#155eef; color:#fff; font-size:1.1rem; }
  .btn[disabled] { background:#9fb5ff; cursor:not-allowed; }
  .hint { color:#666; font-size:.95rem; margin-top:10px; }
</style>
<body>
  <div class="card">
    <h1>Need medical help?</h1>
    <p>Press and hold the button below to alert the on-call doctor. Stay on this page until it says <em>Sent</em>.</p>
    <button id="sendBtn" class="btn">Press & hold 2 seconds to send alert</button>
    <div id="status"></div>
    <p class="hint" id="locHint"></p>
    <noscript><p style="color:#a00">This page needs JavaScript to send the alert.</p></noscript>
  </div>

<script>
/* ===== SET THESE ===== */
const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1435370914417086555/V3tohQhlxNLvBlTWmHHM1uCz80PSsl4PSuE74LIIXWufKdLZ2xPpyM2LKWS84JWXNdT8"; // must start with https://discord.com/api/webhooks/
const SHARED_SECRET = ""; // optional; if set, require ?key=YOUR_SECRET in the URL
/* ===================== */

const $ = (id) => document.getElementById(id);
const statusEl = $('status');
const btn = $('sendBtn');

const p = new URLSearchParams(location.search);
const loc = p.get('loc') || 'Conference Hall';
const who = p.get('who') || 'attendee';
const key = p.get('key') || '';
$('locHint').textContent = `Location: ${loc}`;

if (!DISCORD_WEBHOOK_URL || !/^https:\/\/discord\.com\/api\/webhooks\//.test(DISCORD_WEBHOOK_URL)) {
  statusEl.textContent = 'Setup error: webhook URL missing.';
  btn.disabled = true;
}

if (SHARED_SECRET && key !== SHARED_SECRET) {
  statusEl.textContent = 'Access denied: invalid key.';
  btn.disabled = true;
}

// prevent repeated sends from the same device for the same location
const SEND_KEY = `alert_sent_${loc}`;
if (localStorage.getItem(SEND_KEY) === '1') {
  statusEl.textContent = 'Already sent from this device for this location.';
}

// hold-to-send logic (2 seconds)
let holdTimer = null;
let holdProgress = 0;
const HOLD_MS = 2000;

function startHold() {
  if (btn.disabled) return;
  statusEl.textContent = 'Holdâ€¦';
  holdProgress = 0;
  holdTimer = setInterval(() => {
    holdProgress += 100;
    if (holdProgress >= HOLD_MS) {
      clearInterval(holdTimer); holdTimer = null;
      sendAlert();
    }
  }, 100);
}
function cancelHold() {
  if (holdTimer) { clearInterval(holdTimer); holdTimer = null; statusEl.textContent = ''; }
}

btn.addEventListener('pointerdown', startHold);
btn.addEventListener('pointerup', cancelHold);
btn.addEventListener('pointerleave', cancelHold);
btn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') startHold(); });
btn.addEventListener('keyup', (e) => { if (e.key === 'Enter' || e.key === ' ') cancelHold(); });

async function sendAlert() {
  if (localStorage.getItem(SEND_KEY) === '1') {
    statusEl.textContent = 'Already sent from this device for this location.';
    return;
  }
  btn.disabled = true;
  const now = new Date().toISOString();
  const content = [
    'ðŸš¨ Medical help requested',
    'Location: ' + loc,
    'From: ' + who,
    'Time (UTC): ' + now
  ].join('\n');

  try {
    const res = await fetch(DISCORD_WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content })
    });
    if (res.ok) {
      statusEl.textContent = 'Sent âœ…';
      localStorage.setItem(SEND_KEY, '1');
    } else {
      statusEl.textContent = 'Failed (Discord HTTP ' + res.status + ')';
      btn.disabled = false; // allow retry
    }
  } catch (e) {
    statusEl.textContent = 'Failed (network error)';
    btn.disabled = false;
  }
}
</script>
</body>
</html>
